# ============================================================================
# OCTILI CASHIER - CI/CD DEPLOYMENT WORKFLOW
# ============================================================================
#
# Pipeline Flow:
# - develop branch: Build â†’ Deploy to Dev (fast, no QA)
# - master branch:  Build â†’ QA (Klava) â†’ Deploy to Production
#
# @author Octili Development Team
# @version 2.1.0

name: Build & Deploy

on:
  push:
    branches:
      - master
      - develop
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # ============================================================================
  # BUILD APPLICATION
  # ============================================================================
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: TypeScript check
        run: npx tsc --noEmit

      - name: Build
        run: npm run build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 3

  # ============================================================================
  # DEPLOY TO DEV - Direct deploy, no QA required
  # ============================================================================
  deploy-dev:
    name: Deploy to Dev
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment:
      name: development
      url: https://devcashier.octili.com

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Create .htaccess
        run: |
          cat > dist/.htaccess << 'EOF'
          RewriteEngine On
          RewriteBase /
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteRule ^ index.html [L]
          EOF

      - name: Deploy via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.SFTP_HOST }}
          port: ${{ secrets.SFTP_PORT }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          local_path: './dist/*'
          remote_path: '/domains/octili.com/public_html/devcashier/'
          sftp_only: true
          delete_remote_files: true

      - name: Done
        run: echo "âœ… Deployed to https://devcashier.octili.com"

  # ============================================================================
  # KLAVA QA - Only runs for master branch
  # ============================================================================
  qa-klava:
    name: "QA (Klava)"
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: "Klava: TypeScript Strict"
        run: |
          echo "ðŸ§ª TypeScript strict mode..."
          npx tsc --noEmit --strict
          echo "âœ… Passed"

      - name: "Klava: Run Automated Tests"
        run: |
          echo "ðŸ§ª Running automated tests..."
          npm test
          echo "âœ… All tests passed"

      - name: "Klava: Debug Statements"
        run: |
          echo "ðŸ§ª Checking for console.log..."
          if grep -r "console\.log" src/ --include="*.ts" --include="*.tsx" | grep -v ".test." | head -10; then
            echo "âš ï¸ Found console.log (review if intentional)"
          else
            echo "âœ… Clean"
          fi

      - name: "Klava: Hardcoded Secrets"
        run: |
          echo "ðŸ§ª Checking for secrets..."
          if grep -rE "(password|secret|api_key)\s*[:=]\s*['\"][^'\"]+['\"]" src/ --include="*.ts" --include="*.tsx" -i | grep -v "type\|interface"; then
            echo "âŒ Hardcoded secrets found!"
            exit 1
          fi
          echo "âœ… No secrets"

      - name: "Klava: Security Patterns"
        run: |
          echo "ðŸ§ª Security check..."
          if grep -r "eval(" src/ --include="*.ts" --include="*.tsx"; then
            echo "âŒ eval() detected!"
            exit 1
          fi
          echo "âœ… Secure"

      - name: "Klava: Bundle Analysis"
        run: |
          echo "ðŸ§ª Bundle size..."
          TOTAL=$(du -sh dist/ | cut -f1)
          echo "ðŸ“¦ Total: $TOTAL"
          find dist/ -type f -name "*.js" -exec du -h {} + | sort -rh | head -5

      - name: "Klava: QA Report"
        run: |
          echo "=============================================="
          echo "ðŸ§ª KLAVA QA REPORT"
          echo "=============================================="
          echo ""
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "âœ… TypeScript Strict: PASSED"
          echo "âœ… Automated Tests: PASSED"
          echo "âœ… Security Checks: PASSED"
          echo "âœ… Bundle Analysis: COMPLETE"
          echo ""
          echo "=============================================="
          echo "ðŸŽ‰ QA VERIFICATION PASSED"
          echo "=============================================="
          echo "âœ… Ready for production deployment"

  # ============================================================================
  # DEPLOY TO PRODUCTION - Only after QA passes
  # ============================================================================
  deploy-production:
    name: Deploy to Production
    needs: [build, qa-klava]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    environment:
      name: production
      url: https://democashier.octili.com

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Create .htaccess
        run: |
          cat > dist/.htaccess << 'EOF'
          RewriteEngine On
          RewriteBase /
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteRule ^ index.html [L]
          EOF

      - name: Deploy via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.SFTP_HOST }}
          port: ${{ secrets.SFTP_PORT }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          local_path: './dist/*'
          remote_path: '/domains/octili.com/public_html/democashier/'
          sftp_only: true
          delete_remote_files: true

      - name: Done
        run: echo "âœ… Deployed to https://democashier.octili.com"
